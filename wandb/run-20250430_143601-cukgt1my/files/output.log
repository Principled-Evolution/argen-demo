Initializing GRPOTrainer for model unsloth/Llama-3.2-1B-Instruct...
Starting GRPO training...
[34m[1mwandb[0m: [33mWARNING[0m The `run_name` is currently set to the same value as `TrainingArguments.output_dir`. If this was not intended, please specify a different run name by setting the `TrainingArguments.run_name` parameter.
  0%|                                                                       | 0/60 [00:00<?, ?it/s]`generation_config` default values have been modified to match model-specific defaults: {'max_length': 131072, 'top_p': 0.9}. If this is not desired, please set these values explicitly.
INFO:src.reward_functions.openai_rewards:Evaluating Ahimsa with OpenAI...
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO:src.reward_functions.openai_rewards:Successfully received and parsed OpenAI Ahimsa response (attempt 1).
INFO:src.reward_functions.openai_rewards:Evaluating Ahimsa with OpenAI...
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO:src.reward_functions.openai_rewards:Successfully received and parsed OpenAI Ahimsa response (attempt 1).
INFO:src.reward_functions.openai_rewards:Ahimsa eval: Missing medical disclaimer, penalizing score.
INFO:src.reward_functions.openai_rewards:Evaluating Ahimsa with OpenAI...
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO:src.reward_functions.openai_rewards:Successfully received and parsed OpenAI Ahimsa response (attempt 1).
INFO:src.reward_functions.openai_rewards:Ahimsa eval: Missing medical disclaimer, penalizing score.
INFO:src.reward_functions.openai_rewards:Ahimsa eval: Missing professional referral, penalizing score.
INFO:src.reward_functions.openai_rewards:Evaluating Ahimsa with OpenAI...
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO:src.reward_functions.openai_rewards:Successfully received and parsed OpenAI Ahimsa response (attempt 1).
INFO:src.reward_functions.openai_rewards:Evaluating Dharma with OpenAI...
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO:src.reward_functions.openai_rewards:Successfully received and parsed OpenAI Dharma response (attempt 1).
INFO:src.reward_functions.openai_rewards:Evaluating Dharma with OpenAI...
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO:src.reward_functions.openai_rewards:Successfully received and parsed OpenAI Dharma response (attempt 1).
INFO:src.reward_functions.openai_rewards:Evaluating Dharma with OpenAI...
ERROR:asyncio:Task exception was never retrieved
future: <Task finished name='Task-14' coro=<AsyncClient.aclose() done, defined at /home/kapil/argen-demo/.venv/lib/python3.11/site-packages/httpx/_client.py:1978> exception=RuntimeError('Event loop is closed')>
Traceback (most recent call last):
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1985, in aclose
    await self._transport.aclose()
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/httpx/_transports/default.py", line 406, in aclose
    await self._pool.aclose()
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/httpcore/_async/connection_pool.py", line 353, in aclose
    await self._close_connections(closing_connections)
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/httpcore/_async/connection_pool.py", line 345, in _close_connections
    await connection.aclose()
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/httpcore/_async/connection.py", line 173, in aclose
    await self._connection.aclose()
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/httpcore/_async/http11.py", line 258, in aclose
    await self._network_stream.aclose()
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/httpcore/_backends/anyio.py", line 53, in aclose
    await self._stream.aclose()
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/anyio/streams/tls.py", line 216, in aclose
    await self.transport_stream.aclose()
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 1314, in aclose
    self._transport.close()
  File "/home/kapil/.pyenv/versions/3.11.9/lib/python3.11/asyncio/selector_events.py", line 864, in close
    self._loop.call_soon(self._call_connection_lost, None)
  File "/home/kapil/.pyenv/versions/3.11.9/lib/python3.11/asyncio/base_events.py", line 762, in call_soon
    self._check_closed()
  File "/home/kapil/.pyenv/versions/3.11.9/lib/python3.11/asyncio/base_events.py", line 520, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
ERROR:asyncio:Task exception was never retrieved
future: <Task finished name='Task-15' coro=<AsyncClient.aclose() done, defined at /home/kapil/argen-demo/.venv/lib/python3.11/site-packages/httpx/_client.py:1978> exception=RuntimeError('Event loop is closed')>
Traceback (most recent call last):
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1985, in aclose
    await self._transport.aclose()
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/httpx/_transports/default.py", line 406, in aclose
    await self._pool.aclose()
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/httpcore/_async/connection_pool.py", line 353, in aclose
    await self._close_connections(closing_connections)
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/httpcore/_async/connection_pool.py", line 345, in _close_connections
    await connection.aclose()
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/httpcore/_async/connection.py", line 173, in aclose
    await self._connection.aclose()
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/httpcore/_async/http11.py", line 258, in aclose
    await self._network_stream.aclose()
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/httpcore/_backends/anyio.py", line 53, in aclose
    await self._stream.aclose()
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/anyio/streams/tls.py", line 216, in aclose
    await self.transport_stream.aclose()
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 1314, in aclose
    self._transport.close()
  File "/home/kapil/.pyenv/versions/3.11.9/lib/python3.11/asyncio/selector_events.py", line 864, in close
    self._loop.call_soon(self._call_connection_lost, None)
  File "/home/kapil/.pyenv/versions/3.11.9/lib/python3.11/asyncio/base_events.py", line 762, in call_soon
    self._check_closed()
  File "/home/kapil/.pyenv/versions/3.11.9/lib/python3.11/asyncio/base_events.py", line 520, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
ERROR:asyncio:Task exception was never retrieved
future: <Task finished name='Task-16' coro=<AsyncClient.aclose() done, defined at /home/kapil/argen-demo/.venv/lib/python3.11/site-packages/httpx/_client.py:1978> exception=RuntimeError('Event loop is closed')>
Traceback (most recent call last):
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1985, in aclose
    await self._transport.aclose()
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/httpx/_transports/default.py", line 406, in aclose
    await self._pool.aclose()
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/httpcore/_async/connection_pool.py", line 353, in aclose
    await self._close_connections(closing_connections)
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/httpcore/_async/connection_pool.py", line 345, in _close_connections
    await connection.aclose()
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/httpcore/_async/connection.py", line 173, in aclose
    await self._connection.aclose()
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/httpcore/_async/http11.py", line 258, in aclose
    await self._network_stream.aclose()
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/httpcore/_backends/anyio.py", line 53, in aclose
    await self._stream.aclose()
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/anyio/streams/tls.py", line 216, in aclose
    await self.transport_stream.aclose()
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 1314, in aclose
    self._transport.close()
  File "/home/kapil/.pyenv/versions/3.11.9/lib/python3.11/asyncio/selector_events.py", line 864, in close
    self._loop.call_soon(self._call_connection_lost, None)
  File "/home/kapil/.pyenv/versions/3.11.9/lib/python3.11/asyncio/base_events.py", line 762, in call_soon
    self._check_closed()
  File "/home/kapil/.pyenv/versions/3.11.9/lib/python3.11/asyncio/base_events.py", line 520, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
ERROR:asyncio:Task exception was never retrieved
future: <Task finished name='Task-17' coro=<AsyncClient.aclose() done, defined at /home/kapil/argen-demo/.venv/lib/python3.11/site-packages/httpx/_client.py:1978> exception=RuntimeError('Event loop is closed')>
Traceback (most recent call last):
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/httpx/_client.py", line 1985, in aclose
    await self._transport.aclose()
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/httpx/_transports/default.py", line 406, in aclose
    await self._pool.aclose()
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/httpcore/_async/connection_pool.py", line 353, in aclose
    await self._close_connections(closing_connections)
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/httpcore/_async/connection_pool.py", line 345, in _close_connections
    await connection.aclose()
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/httpcore/_async/connection.py", line 173, in aclose
    await self._connection.aclose()
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/httpcore/_async/http11.py", line 258, in aclose
    await self._network_stream.aclose()
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/httpcore/_backends/anyio.py", line 53, in aclose
    await self._stream.aclose()
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/anyio/streams/tls.py", line 216, in aclose
    await self.transport_stream.aclose()
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 1314, in aclose
    self._transport.close()
  File "/home/kapil/.pyenv/versions/3.11.9/lib/python3.11/asyncio/selector_events.py", line 864, in close
    self._loop.call_soon(self._call_connection_lost, None)
  File "/home/kapil/.pyenv/versions/3.11.9/lib/python3.11/asyncio/base_events.py", line 762, in call_soon
    self._check_closed()
  File "/home/kapil/.pyenv/versions/3.11.9/lib/python3.11/asyncio/base_events.py", line 520, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO:src.reward_functions.openai_rewards:Successfully received and parsed OpenAI Dharma response (attempt 1).
INFO:src.reward_functions.openai_rewards:Evaluating Dharma with OpenAI...
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO:src.reward_functions.openai_rewards:Successfully received and parsed OpenAI Dharma response (attempt 1).
Traceback (most recent call last):
  File "/home/kapil/argen-demo/examples/train_grpo.py", line 284, in <module>
    main()
  File "/home/kapil/argen-demo/examples/train_grpo.py", line 274, in main
    trainer.train()
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/transformers/trainer.py", line 2245, in train
    return inner_training_loop(
           ^^^^^^^^^^^^^^^^^^^^
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/transformers/trainer.py", line 2593, in _inner_training_loop
    _grad_norm = self.accelerator.clip_grad_norm_(
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/accelerate/accelerator.py", line 2609, in clip_grad_norm_
    self.unscale_gradients()
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/accelerate/accelerator.py", line 2548, in unscale_gradients
    self.scaler.unscale_(opt)
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/torch/amp/grad_scaler.py", line 342, in unscale_
    optimizer_state["found_inf_per_device"] = self._unscale_grads_(
                                              ^^^^^^^^^^^^^^^^^^^^^
  File "/home/kapil/argen-demo/.venv/lib/python3.11/site-packages/torch/amp/grad_scaler.py", line 283, in _unscale_grads_
    torch._amp_foreach_non_finite_check_and_unscale_(
RuntimeError: "_amp_foreach_non_finite_check_and_unscale_cuda" not implemented for 'BFloat16'
